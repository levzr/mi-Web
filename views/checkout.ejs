<%- include('parcial/header') %>

<section class="checkout-container">
  <div class="checkout-card">
    <h1>Finalizar Pedido</h1>
    <p class="subtitle">Revisa tus datos y confirma tu orden.</p>

    <% if (typeof error !== 'undefined' && error) { %>
      <p style="color:#f97373;margin-bottom:12px;"><%= error %></p>
    <% } %>

    <form action="/checkout" method="POST" class="checkout-form">
      <!-- Datos del cliente -->
      <div class="form-section">
        <h2>Datos del Cliente</h2>

        <input
          type="text" name="nombre" placeholder="Nombre completo" required
          minlength="3" pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]{3,60}$"
          title="Solo letras y espacios, mínimo 3 caracteres."
          value="<%= user ? user.nombre : '' %>">

        <input
          type="text" name="direccion" placeholder="Dirección de entrega" required
          minlength="5" value="<%= user && user.direccion ? user.direccion : '' %>">

        <input
          type="tel" name="telefono" placeholder="Teléfono" required
          pattern="^[0-9]{8,15}$" title="Solo números, entre 8 y 15 dígitos."
          value="<%= user && user.telefono ? user.telefono : '' %>">
      </div>

      <!-- Pedido seleccionado -->
      <div class="form-section">
        <h2>Resumen del Pedido</h2>
        <div class="pedido-box">
          <p><strong>Restaurante:</strong> <%= restaurante || "—" %></p>
          <p><strong>Plato:</strong> <%= plato || "—" %></p>
          <p><strong>Precio:</strong> L <%= precio || "0" %></p>
        </div>

        <!-- Campos ocultos -->
        <input type="hidden" name="restauranteId" value="<%= restaurante || '' %>">
        <input type="hidden" name="pedido" value="<%= plato || '' %>">
        <input type="hidden" name="precio" value="<%= precio || '0' %>">
      </div>

      <!-- Programar entrega -->
      <div class="form-section">
        <h2>Programar Entrega</h2>

        <label for="scheduleDate">Fecha:</label>
        <input
          type="date"
          id="scheduleDate"
          name="scheduleDate"
          required
        >

        <label for="scheduleSlot">Hora:</label>
        <select id="scheduleSlot" name="scheduleSlot" required>
          <option value="">Selecciona una franja</option>
          <option value="Inmediato" data-start="now">Inmediato (40–60 min)</option>
          <option value="10:00-11:00" data-start="10:00">10:00 – 11:00</option>
          <option value="11:00-12:00" data-start="11:00">11:00 – 12:00</option>
          <option value="12:00-13:00" data-start="12:00">12:00 – 13:00</option>
          <option value="13:00-14:00" data-start="13:00">13:00 – 14:00</option>
          <option value="14:00-15:00" data-start="14:00">14:00 – 15:00</option>
          <option value="15:00-16:00" data-start="15:00">15:00 – 16:00</option>
          <option value="16:00-17:00" data-start="16:00">16:00 – 17:00</option>
          <option value="17:00-18:00" data-start="17:00">17:00 – 18:00</option>
          <option value="18:00-19:00" data-start="18:00">18:00 – 19:00</option>
          <option value="19:00-20:00" data-start="19:00">19:00 – 20:00</option>
          <option value="20:00-21:00" data-start="20:00">20:00 – 21:00</option>
          <option value="21:00-22:00" data-start="21:00">21:00 – 22:00</option>
          <option value="22:00-23:00" data-start="22:00">22:00 – 23:00</option>
        </select>
      </div>

      <button type="submit" class="btn-confirmar">Confirmar Pedido</button>
    </form>
  </div>
</section>

<script>
  (function () {
    const dateInput = document.getElementById('scheduleDate');
    const slotSelect = document.getElementById('scheduleSlot');
    if (!dateInput || !slotSelect) return;

    // === Rango de fechas: hoy a +7 días ===
    const today = new Date();
    today.setHours(0,0,0,0);
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const minDate = `${yyyy}-${mm}-${dd}`;

    const future = new Date(today);
    future.setDate(future.getDate() + 7);
    const yyyyF = future.getFullYear();
    const mmF = String(future.getMonth() + 1).padStart(2, '0');
    const ddF = String(future.getDate()).padStart(2, '0');
    const maxDate = `${yyyyF}-${mmF}-${ddF}`;

    dateInput.min = minDate;
    dateInput.max = maxDate;
    dateInput.value = minDate;

    function resetSlots() {
      Array.from(slotSelect.options).forEach(opt => {
        opt.disabled = false;
        opt.hidden = false;
      });
      slotSelect.value = "";
    }
    function updateSlots() {
      resetSlots();

      const selectedDate = new Date(dateInput.value);
      selectedDate.setHours(0,0,0,0);
      if (isNaN(selectedDate.getTime())) return;

      const isToday = selectedDate.getTime() === today.getTime();
      if (!isToday) return; 

      const now = new Date();
      const limit = new Date(now.getTime() + 40 * 60000); 

      Array.from(slotSelect.options).forEach(opt => {
        const start = opt.getAttribute('data-start');
        if (!start || opt.value === "") return;

        if (start === 'now') {
          return;
        }
        const [h, m] = start.split(':').map(Number);
        const slotTime = new Date();
        slotTime.setHours(h, m || 0, 0, 0);

        if (limit >= slotTime) {
          opt.disabled = true;
          opt.hidden = true;
        }
      });

      if (slotSelect.selectedOptions[0] && slotSelect.selectedOptions[0].disabled) {
        slotSelect.value = "";
      } }
    dateInput.addEventListener('change', updateSlots);
    updateSlots();
  })();
</script>


<%- include('parcial/footer') %>


