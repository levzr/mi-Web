<%- include('parcial/header') %>

<section class="checkout-container">
  <div>
    <h1>Mis pedidos</h1>

    <% if (pedidos.length === 0) { %>
      <p>No tienes pedidos registrados.</p>
      <a href="/" class="btn-primary">Realizar pedido</a>
    <% } else { %>
      <ul class="order-list">
        <% pedidos.forEach(p => { %>
          <li class="order-item" style="margin-bottom:20px;">

            <% if (p.estado === 'borrador') { %>
              <div class="pedido-form-row">
                <form action="/pedidos/<%= p.id %>/agregar" method="POST" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <select name="platoId" required>
                    <% platos.forEach(plato => { %>
                      <option value="<%= plato.id %>"><%= plato.nombre %></option>
                    <% }) %>
                  </select>
                  <input type="number" name="cantidad" min="1" value="1" required>
                  <button type="submit" class="btn-primary btn-sm">Añadir</button>
                </form>
              </div>

              <form action="/pedidos/<%= p.id %>/confirmar" method="POST" class="confirmar-btn">
                <button type="submit" class="btn-primary btn-sm">Confirmar este pedido</button>
              </form>
            <% } %>

            <p><strong>Cliente:</strong> <%= p.nombre %></p>
            <p><strong>Restaurante:</strong> <%= p.restaurante_nombre || '-' %></p>

            <p><strong>Platos del pedido:</strong></p>
            <ul>
              <% (detallesPorPedido[p.id] || []).forEach(d => { %>

                <li>
                  <%= d.nombre %> x <%= d.cantidad %> — L <%= (d.precio * d.cantidad).toFixed(2) %>
                  <% if (p.estado === 'borrador') { %>
                    <form action="/pedidos/<%= p.id %>/detalles/<%= d.id %>/eliminar" method="POST" style="display:inline;">
                      <button type="submit" class="btn-danger btn-xs">Quitar</button>
                    </form>
                  <% } %>
                </li>
              <% }) %>
            </ul>

            <p style="margin-top:6px;">
              <strong>Total del pedido:</strong>
              L <%= (totalesPorPedido[p.id] || 0).toFixed(2) %>
            </p>

            <p><strong>Fecha:</strong> <%= p.fecha.toLocaleString() %></p>
            <p><strong>Entrega:</strong> <%= (p.schedule_date || '') + ' ' + (p.schedule_slot || '') %></p>
            <p><strong>Entrega:</strong> <%= (p.schedule_date || '') + ' ' + (p.schedule_slot || '') %></p>

<% if (p.estado === 'borrador') { %>
  <form action="/pedidos/<%= p.id %>/eliminar" method="POST"
        onsubmit="return confirm('¿Eliminar este pedido completo?');"
        style="margin-top:8px;">
    <button type="submit" class="btn-danger btn-sm">Eliminar pedido</button>
  </form>
<% } %>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </div>
</section>

<%- include('parcial/footer') %>





